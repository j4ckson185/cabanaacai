<script>
    document.addEventListener('DOMContentLoaded', function() {
        const deliveryFee = 3.00;
        const carrinho = JSON.parse(sessionStorage.getItem('carrinho')) || [];
        let subtotal = 0;

        carrinho.forEach(item => {
            let valorProduto = parseFloat(item.preco);
            item.extras.forEach(extra => {
                valorProduto += parseFloat(extra.match(/\+R\$([0-9,]+)/)[1].replace(',', '.'));
            });
            subtotal += valorProduto;
        });

        const total = subtotal + deliveryFee;

        document.getElementById('subtotal').textContent = formatarMoeda(subtotal);
        document.getElementById('total').textContent = formatarMoeda(total);

        // Verificação de horários de funcionamento
        const horarios = JSON.parse(localStorage.getItem('horarios')) || {};
        const now = moment().tz("America/Sao_Paulo");
        const day = now.format('dddd').toLowerCase();
        const currentTime = now.hours() * 60 + now.minutes();
        const openTime = horarios[day]?.open ? parseInt(horarios[day].open.split(':')[0]) * 60 + parseInt(horarios[day].open.split(':')[1]) : null;
        const closeTime = horarios[day]?.close ? parseInt(horarios[day].close.split(':')[0]) * 60 + parseInt(horarios[day].close.split(':')[1]) : null;

        console.log('Horário de funcionamento:', horarios);
        console.log('Dia atual:', day);
        console.log('Horário atual em minutos:', currentTime);
        console.log('Horário de abertura em minutos:', openTime);
        console.log('Horário de fechamento em minutos:', closeTime);

        if (openTime !== null && closeTime !== null) {
            if (currentTime < openTime || currentTime > closeTime) {
                document.getElementById('closed-message').classList.remove('hidden');
            } else {
                document.getElementById('formulario-pagamento').classList.remove('hidden');
            }
        } else {
            document.getElementById('closed-message').classList.remove('hidden');
        }

        // Exibir seção de troco ao selecionar pagamento em dinheiro
        document.querySelectorAll('input[name="payment-method"]').forEach(input => {
            input.addEventListener('change', function() {
                if (this.value === 'dinheiro') {
                    document.getElementById('troco-section').style.display = 'block';
                } else {
                    document.getElementById('troco-section').style.display = 'none';
                }
            });
        });
    });

    document.getElementById('formulario-pagamento').addEventListener('submit', function(e) {
        e.preventDefault();

        const nomeSobrenome = document.getElementById('nome-sobrenome').value;
        const cep = document.getElementById('cep').value;
        const endereco = document.getElementById('endereco').value;
        const numero = document.getElementById('numero').value;
        const complemento = document.getElementById('complemento').value || "N/A";
        const telefone = document.getElementById('telefone').value;
        const email = document.getElementById('email').value;
        const metodoPagamento = document.querySelector('input[name="payment-method"]:checked').value;
        const troco = document.getElementById('troco').value;
        const deliveryOption = 3.00;

        const carrinho = JSON.parse(sessionStorage.getItem('carrinho')) || [];
        let mensagemCarrinho = "*Itens do Pedido:*\n";
        let subtotal = 0;
        carrinho.forEach(item => {
            let valorProduto = parseFloat(item.preco);
            item.extras.forEach(extra => {
                valorProduto += parseFloat(extra.match(/\+R\$([0-9,]+)/)[1].replace(',', '.'));
            });
            subtotal += valorProduto;

            mensagemCarrinho += `\n*${item.nome} - ${formatarMoeda(valorProduto)}*\n`;
            mensagemCarrinho += "Sabores:\n";
            item.sabores.forEach(sabor => {
                mensagemCarrinho += `- ${sabor}\n`;
            });
            mensagemCarrinho += "Acompanhamentos:\n";
            item.acompanhamentos.forEach(acompanhamento => {
                mensagemCarrinho += `- ${acompanhamento}\n`;
            });
            mensagemCarrinho += "Itens Extras:\n";
            item.extras.forEach(extra => {
                mensagemCarrinho += `- ${extra}\n`;
            });
        });

        const desconto = parseFloat(document.getElementById('desconto').textContent.replace("R$", "").replace(",", ".")) || 0;
        const total = subtotal + deliveryOption - desconto;

        let mensagem = `*Pedido Cabana Açaí*\n\n*Nome:* ${nomeSobrenome}\n*CEP:* ${cep}\n*Endereço:* ${endereco}, ${numero}\n*Complemento:* ${complemento}\n*Telefone:* ${telefone}\n*Email:* ${email}\n*Método de Pagamento:* ${metodoPagamento}\n${mensagemCarrinho}\n*Taxa de Entrega:* ${formatarMoeda(deliveryOption)}\n*Desconto:* ${formatarMoeda(desconto)}\n*Total do Pedido: ${formatarMoeda(total)}*`;
        
        if (metodoPagamento === 'dinheiro' && troco) {
            mensagem += `\n*Troco para:* ${troco}`;
        }

        const whatsappUrl = `https://wa.me/5584988731028?text=${encodeURIComponent(mensagem)}`;
        window.open(whatsappUrl, '_blank');

        const editarPedidoBtn = document.getElementById('botao-editar-pedido');
        const acompanharPedidoBtn = document.createElement('a');
        acompanharPedidoBtn.href = "meus_pedidos.html";
        acompanharPedidoBtn.className = "button button-track";
        acompanharPedidoBtn.textContent = "Acompanhar Pedido";
        editarPedidoBtn.replaceWith(acompanharPedidoBtn);

        db.collection("orders").add({
            nomeSobrenome: nomeSobrenome,
            cep: cep,
            endereco: endereco,
            numero: numero,
            complemento: complemento,
            telefone: telefone,
            email: email,
            metodoPagamento: metodoPagamento,
            troco: troco,
            itens: carrinho,
            taxaEntrega: formatarMoeda(deliveryOption),
            subtotal: formatarMoeda(subtotal),
            desconto: formatarMoeda(desconto),
            total: formatarMoeda(total),
            status: "Pendente",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then((docRef) => {
            console.log("Pedido salvo com ID: ", docRef.id);
        }).catch((error) => {
            console.error("Erro ao salvar pedido: ", error);
        });
    });

    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
</script>
